<!DOCTYPE>
  <html>
    <head>
      <meta charset="utf-8" />

<!-- rosbridge imports -->
<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>

<!-- roadnarrows platform imports --> 
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="../../../js/rosbridge_global.js"></script>
<script type="text/javascript" src="../../../js/rosbridge_hekateros.js"></script>

    </head>

    <body>
      <style>
        #controlPanel
        {
          height: 500px;
          width:80%;
          min-width:600px;
          max-width:1500px;
          overflow:hidden;
          margin:10px auto;
          background:#ccc;
          position:relative;
        }
        #leftColumn
        {
          float:left;
          position:absolute;
          left:0;
          bottom:0;
        }
        #rightColumn
        {
          float:right;
          position:absolute;
          right:0;
          bottom:0;
        }
        #centerColumn
        {
          width:50%;
          margin: 20 22%;
        }
        .left, .right, .center 
        {
          padding:10px;
          margin:5px;
          border:5px double #222;
          border-radius:5px;
          background-size: contain; 
          /*MIW Change Icon Size Here*/
          background-repeat:no-repeat;
          box-shadow: 3px 3px 3px #555;

        }
        button
        {
          width:125px;
          height:55px;
          display:table;
        }
        hekateros
        {
          width:100%;
          height:15px;
          display:table;
          font-size:25px;
          font-weight:bold;
          text-align:center;
          position:relative;
          padding:0 20 10 20;
        }
        title
        {
          width:100%;
          height:55px;
          display:table;
          text-align:center;
          position:relative;
          padding:10px;
          margin:5px;
          border:5px double #222;
          border-radius:5px;
        }
        main
        {
          width:inherit;
          height:240px;
          display:table;
          text-align:center;
          position:absolute;
          padding:10px;
          margin:5px;
          border:5px double #222;
          border-radius:5px;
        }
        table
        {
          width:100%;
          height:inherit;
          border:1px solid black;
        }
        td, th
        {
          padding: 1px 4px;
        }
        th
        {
          text-align:left;
        }
        .center
        {
          background-color:#090
        }
        button:hover
        {
          cursor:pointer;
        }
        .left:hover
        {
          background-color:#b00;
        }
        .right:hover
        {
          background-color:#b00;
        }
      </style>
      
      <div id="controlPanel">
        <div id="leftColumn">
        </div>
        <div id="centerColumn">
        </div>
        <div id="rightColumn">
        </div>
      </div>
    
      <script>
        var calibrate_action_goal;
        var calibrate_action_feedback;
        var robotState;
        var jointState;
        var i=0;

        window.onload = function(){
          hek.sub_robotStatus(function(message) {
            robotState = message;
            //console.info(message);

          }) 
          hek.sub_jointStates(function(message) {
            jointState = message;
            //console.info(jointState);

          }) 
          
        d3.select("table").call(t);
        window.setInterval(function ()
        {
          updateData();
        },1000)
      }
    

        function buttons_panel(id, name, side, color)
        {
          var panel = d3.select("#" + side + "Column").append("button")
              .attr("id", id)
              .attr("class", side)
              .style("background-color", color)
              .style("background-image", "url('img/" + id + ".png')" )
              //MIW Change icon path here
              .style("text-align", "right")
              .style("text-shadow", "-1px 0 #ccc, 0 1px #ccc, 1px 0 #ccc, 0 -1px #ccc")
              .text(name)
              .attr("onclick", id + "()");
        }
        
        buttons_panel("Calibrate", "Calibrate", "left", "#ccc");
        buttons_panel("Park", "Park", "left", "#ccc");
        buttons_panel("Balance", "Balance", "left", "#ccc");
        buttons_panel("ZeroPoint", "Zero Point", "left", "#ccc");
        buttons_panel("OpenGripper", "Open Gripper", "left", "#ccc");
        buttons_panel("CloseGripper", "Close Gripper", "left", "#ccc");
        buttons_panel("SpecifyMove", "Specify Move", "left", "#ccc");
        buttons_panel("EStop", "EStop", "right", "#900");
        buttons_panel("Freeze", "Freeze", "right", "#ccc");
        buttons_panel("Release", "Release", "right", "#ccc");
        buttons_panel("ClearAlarms", "Clear Alarms", "right", "#ccc");
        buttons_panel("Settings", "Settings", "right", "#ccc");
        buttons_panel("About", "About", "right", "#ccc");
        buttons_panel("Quit", "Quit", "right", "#ccc");
        
        function EStop()
        {
          console.info("EStop");
          d3.select("#EStop").text("Reset EStop").style("background-color", "#090").attr("id","resetEStop").attr("onclick","resetEStop()");
          hek.EStop();  
        } 

        function resetEStop()
        {
          console.info("EStop Reset");
          d3.select("#resetEStop").text("EStop").style("background-color","#900").
  attr("id","EStop").attr("onclick","EStop()");
          hek.resetEStop();
        }

        function Freeze()
        {
          console.info("Freeze");
          hek.freeze();
        }

        function Release()
        {
          console.info("Release");
          hek.release();
        }

        function Calibrate()
        {
          console.info("Calibrate")
          calibrate_action_goal = hek.calibrate();
          calibrate_action_goal.send();
          d3.select("#Calibrate")
              .text("Cancel Calibrate")
              .style("background-color", "#900")
              .style("background-image", "url('img/cancelCalibrate.png')")
              .attr("id","cancelCalibrate")
              .attr("onclick","cancelCalibrate()");
          hek.sub_feedback(function(message) {
            console.info(message);
          })   
        }
        
        function cancelCalibrate()
        {
          console.info("STOP calibration")
          calibrate_action_goal.cancel();
          d3.select("#cancelCalibrate")
              .text("Calibrate")
              .style("background-color","#ccc")
              .style("background-image", "url('img/Calibrate.png')")
              .attr("id","Calibrate")
              .attr("onclick","Calibrate()");
        }

        function Park()
        {
          console.info("Park");
          hek.park();
        }

        function Balance()
        {
          console.info("Balanced");
          hek.balanced();
        }

        function ZeroPoint()
        {
          console.info("Zero Point");
          hek.zeroPoint();
        }

        function OpenGripper()
        {
          console.info("Open Gripper");
          hek.openGripper();
        }

        function CloseGripper()
        {
          console.info("Close Gripper");
          hek.closeGripper();
        }

        function About()
        {
          console.info("about hekateros");
          var productInformation = hek.ProductInfo();
          alert(productInformation);
        }


        var name = d3.select("#centerColumn").append("hekateros")
            .text("Hekateros Control Panel");
        d3.select("#centerColumn").append("title")
            .text("Robot Status");
        d3.select("#centerColumn").append("main")
            .text("Joint State");
     
        var columns;
        var tbl;
        var table;
        var thead;
        var tbody;
        var th;
        var rows;
        var cells;
        var data;

              
        d3.table = function(config) {
          columns = ['joint', 'ServoID', 'State', 'Position', 'Odometer', 'Encoder', 'Velocity', 'Speed', 'Effort', 'Temperature', 'Voltage', 'Alarms'];

          tbl = function(selection) {
            if(columns.length == 0)
            { 
              columns = d3.keys(selection.data()[0][0]);
              console.info(columns);
            }
        
          selection.selectAll('table').data([0]).enter().append('table');
          table = d3.select("main").append('table');
          //var table= selection.select('table');
          
          table.selectAll('thead').data([0]).enter().append('thead');
          thead = table.select('thead');

          table.selectAll('tbody').data([0]).enter().append('tbody');
          tbody = table.select('tbody');

          th = thead.append("tr").selectAll("th")
             .data(columns)

          th.enter().append("th");
          th.text(function(d) { return d;})
          th.exit().remove();
        
          data =[
               {"joint": "base_rot", "ServoID": "01", "State": "NA", "Position": "10", "Odometer": "here", "Encoder": "NA", "Velocity": "NA", "Speed": "NA", "Effort": "NA", "Temperature": "NA", "Voltage": "NA", "Alarms": "NA"}, 
               {"joint": "shoulder", "ServoID": "13", "State": "NA", "Position": "10", "Odometer": "here", "Encoder": "NA", "Velocity": "NA", "Speed": "NA", "Effort": "NA", "Temperature": "NA", "Voltage": "NA", "Alarms": "NA"}, 
               {"joint": "elbow", "ServoID": "34", "State": "NA", "Position": "10", "Odometer": "here", "Encoder": "NA", "Velocity": "NA", "Speed": "NA", "Effort": "NA", "Temperature": "NA", "Voltage": "NA", "Alarms": "NA"},
               {"joint": "wrist-pitch", "ServoID": "10", "State": "NA", "Position": "10", "Odometer": "here", "Encoder": "NA", "Velocity": "NA", "Speed": "NA", "Effort": "NA", "Temperature": "NA", "Voltage": "NA", "Alarms": "NA"},
               {"joint": "wrist-rot", "ServoID": "10", "State": "NA", "Position": "10", "Odometer": "here", "Encoder": "NA", "Velocity": "NA", "Speed": "NA", "Effort": "NA", "Temperature": "NA", "Voltage": "NA", "Alarms": "NA"},
               {"joint": "grip", "ServoID": "10", "State": "NA", "Position": "10", "Odometer": "here", "Encoder": "NA", "Velocity": "NA", "Speed": "NA", "Effort": "NA", "Temperature": "NA", "Voltage": "NA", "Alarms": "NA"}
                    ];

          rows = tbody.selectAll("tr")
              .data(data) 

          rows.enter().append("tr");
          rows.exit().remove();
        
          cells = rows.selectAll("td")
              .data(function(row) 
                   {
                     return columns.map(function(key) 
                                       {
                                         return {key:key, value:row[key]};
                                       });
                   })
          cells.enter().append("td");
          cells.text(function(d) { return d.value; })
              .attr('data-col', function(d,i){ return i})
              .attr('data-key', function(d,i){(d.key); return d.key});
          cells.exit().remove();
          return tbl;
          };
      
          tbl.columns = function(_) {
            if(!arguments.length) { return columns;}
            columns = _;
            return this;
          };

          return tbl;
        };
        
        var t= d3.table();

         

        function updateData() {
          
                    data[0]["ServoID"]=robotState.servo_health[0].servo_id;
                    data[0]["Temperature"]=robotState.servo_health[0].temp;
                    data[0]["Voltage"]=robotState.servo_health[0].voltage.toFixed(2);
                    data[0]["Effort"]=jointState.effort[0];
                    data[0]["Speed"]=jointState.raw_speed[0];
                    data[0]["Odometer"]=jointState.odometer_pos[0];
                    data[0]["Encoder"]=jointState.encoder_pos[0];
                    data[0]["Position"]=jointState.position[0].toFixed(2);
                    data[0]["Velocity"]=jointState.velocity[0].toFixed(2);


                    data[1]["ServoID"]=robotState.servo_health[1].servo_id;
                    data[1]["Temperature"]=robotState.servo_health[1].temp;
                    data[1]["Voltage"]=robotState.servo_health[1].voltage.toFixed(2);
                    data[1]["Effort"]=jointState.effort[1];
                    data[1]["Speed"]=jointState.raw_speed[1];
                    data[1]["Odometer"]=jointState.odometer_pos[1];
                    data[1]["Encoder"]=jointState.encoder_pos[1];
                    data[1]["Position"]=jointState.position[1].toFixed(2);
                    data[1]["Velocity"]=jointState.velocity[1].toFixed(2);
                    
                    
                    data[2]["ServoID"]=robotState.servo_health[3].servo_id;
                    data[2]["Temperature"]=robotState.servo_health[3].temp;
                    data[2]["Voltage"]=robotState.servo_health[3].voltage.toFixed(2);
                    data[2]["Effort"]=jointState.effort[2];
                    data[2]["Speed"]=jointState.raw_speed[2];
                    data[2]["Odometer"]=jointState.odometer_pos[2];
                    data[2]["Encoder"]=jointState.encoder_pos[2];
                    data[2]["Position"]=jointState.position[2].toFixed(2);
                    data[2]["Velocity"]=jointState.velocity[2].toFixed(2);
                    
                    
                    data[3]["ServoID"]=robotState.servo_health[4].servo_id;
                    data[3]["Temperature"]=robotState.servo_health[4].temp;
                    data[3]["Voltage"]=robotState.servo_health[4].voltage.toFixed(2);
                    data[3]["Effort"]=jointState.effort[3];
                    data[3]["Speed"]=jointState.raw_speed[3];
                    data[3]["Odometer"]=jointState.odometer_pos[3];
                    data[3]["Encoder"]=jointState.encoder_pos[3];
                    data[3]["Position"]=jointState.position[3].toFixed(2);
                    data[3]["Velocity"]=jointState.velocity[3].toFixed(2);
                    
                    
                    data[4]["ServoID"]=robotState.servo_health[5].servo_id;
                    data[4]["Temperature"]=robotState.servo_health[5].temp;
                    data[4]["Voltage"]=robotState.servo_health[5].voltage.toFixed(2);
                    data[4]["Effort"]=jointState.effort[4];
                    data[4]["Speed"]=jointState.raw_speed[4];
                    data[4]["Odometer"]=jointState.odometer_pos[4];
                    data[4]["Encoder"]=jointState.encoder_pos[4];
                    data[4]["Position"]=jointState.position[4].toFixed(2);
                    data[4]["Velocity"]=jointState.velocity[4].toFixed(2);
                    
                    
                    data[5]["ServoID"]=robotState.servo_health[6].servo_id;
                    data[5]["Temperature"]=robotState.servo_health[6].temp;
                    data[5]["Voltage"]=robotState.servo_health[6].voltage.toFixed(2);
                    data[5]["Effort"]=jointState.effort[5];
                    data[5]["Speed"]=jointState.raw_speed[5];
                    data[5]["Odometer"]=jointState.odometer_pos[5];
                    data[5]["Encoder"]=jointState.encoder_pos[5];
                    data[5]["Position"]=jointState.position[5].toFixed(2);
                    data[5]["Velocity"]=jointState.velocity[5].toFixed(2);
                    
          var i;  
          for(i = 0; i<6; i++)  
          {        
            if(jointState.op_state[i] == 0)
            {
              data[i]["State"]="uncalibrated";
            }
            else if(jointState.op_state[i] == 1)
            {
              data[i]["State"]="calibrating";
            }          
            else
            {
              data[i]["State"]="calibrated";
            }
          }
          /*var j;
          for(j = 0; j<7; j++)  
          {        
            if(i==2)
            {
              continue;
            }
            else if(jointState.servo_health[i].alarm == 0)
            {
              data[i]["Alarm"]="ok";
            }
            else if(jointState.op_state[i].alarm == 1)
            {
              data[i]["Alarm"]="ok";
            }          
            else
            {
              data[i]["Alarm"]="ok";
            }
         } */

          rows.data(data)

          cells
              .data(function(row) 
                   {
                     return columns.map(function(key) 
                                       {
                                         return {key:key, value:row[key]};
                                       });
                   })
              .text(function(d) { return d.value; });

          
        };
       
      </script>
    </body>
</html>




